---
- name: Verify - Nginx is running
  hosts: all
  become: false
  tasks:
    - name: Show listening ports
      shell: ss -tuln
      register: port_info
    - debug:
        var: port_info.stdout_lines
        
    - name: Include default vars
      ansible.builtin.include_vars:
        dir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/defaults/"
        extensions:
          - "yml"

    - name: Wait for GitLab web interface to become reachable
      ansible.builtin.wait_for:
        port: "{{ gitlab__port_web_http }}"
        host: "localhost"
        delay: 10         # initial wait
        timeout: 300
        state: started

    - name: Check that the default page is running
      ansible.builtin.uri:
        url: "http://localhost:{{ gitlab__port_web_http }}"
        return_content: true
      register: local_webserver_output
      failed_when: local_webserver_output is failed or local_webserver_output.status != 200

    - name: Show output
      ansible.builtin.debug:
        var: local_webserver_output
