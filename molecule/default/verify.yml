---
- name: Verify - GitLab HTTP is running
  hosts: all
  become: false
  tasks:
    - name: Include default vars
      ansible.builtin.include_vars:
        dir: "{{ lookup('env','MOLECULE_PROJECT_DIRECTORY') }}/defaults"
        extensions: ["yml"]

    - name: Wait for GitLab container to boot (TCP port open)
      wait_for:
        port: 80
        host: >-
          {{ lookup('pipe', "docker inspect -f '{{ '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' }}' " ~ gitlab__name) }}
        timeout: 300
      register: wait_result
      ignore_errors: true  # So the next debug step works if it fails

    - name: Get GitLab container IP
      shell: docker inspect -f '{{"{{"}}range .NetworkSettings.Networks{{"{{"}}.IPAddress{{"{{"}}end{{"}}"}}' {{ gitlab__name }}
      register: gitlab_ip
      changed_when: false

    - name: Use first IP in case of multiple
      set_fact:
        gitlab_main_ip: "{{ gitlab_ip.stdout_lines[0] }}"

    - name: Show GitLab container IP
      debug:
        var: gitlab_main_ip

    - name: Wait until GitLab returns 200 OK
      uri:
        url: "http://{{ gitlab_main_ip }}"
        return_content: true
      register: web_check
      retries: 30
      delay: 20
      until: web_check.status == 200
      failed_when: web_check is failed or web_check.status != 200

    - name: Show HTTP check result
      debug:
        var: web_check